"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.fromDecimal = exports.toDecimal = exports.fromBigint = exports.fromBN = exports.safePow = exports.safeSqrt = exports.safeNthRoot = exports.safeMul = exports.safeDiv = exports.variance = exports.max = exports.min = exports.weightedMedian = exports.weightedAverage = exports.median = void 0;
const big_js_1 = require("big.js");
const bn_js_1 = __importDefault(require("bn.js"));
const decimal_js_1 = require("decimal.js");
function comparator(a, b) {
    if (a.gt(b)) {
        return 1;
    }
    if (a.lt(b)) {
        return -1;
    }
    return 0;
}
function median(results) {
    if (!results?.length)
        throw new Error("Cannot take median of empty array.");
    const arrSort = results.slice().sort(comparator);
    const mid = Math.ceil(arrSort.length / 2);
    if (arrSort.length % 2 === 0) {
        const addition = arrSort[mid].add(arrSort[mid - 1]);
        return safeDiv(addition, new big_js_1.Big(2.0));
    }
    return arrSort[mid - 1];
}
exports.median = median;
function weightedAverage(v1, w1, v2, w2) {
    return safeDiv(safeMul(v1, w1).add(safeMul(v2, w2)), w1.add(w2));
}
exports.weightedAverage = weightedAverage;
function weightedMedian(results) {
    if (!results?.length)
        throw new Error("Cannot take median of empty array.");
    for (let i = 0; i < results.length; ++i) {
        if (results[i].weight === 0) {
            results[i].weight = 1;
        }
    }
    const arrSort = results.slice().sort((a, b) => comparator(a.value, b.value));
    const halfWeight = arrSort.reduce((sum, { weight }) => weight + sum, 0) / 2;
    let i = 0;
    let w = 0;
    // get the index (i) and total weight (w) of item just above half
    for (; w < halfWeight; ++i) {
        w = w + arrSort[i].weight;
    }
    // if it actually is exactly the half, we need to take the average
    if (w === halfWeight) {
        return weightedAverage(arrSort[i - 1].value, new big_js_1.Big(arrSort[i - 1].weight), arrSort[i].value, new big_js_1.Big(arrSort[i].weight));
    }
    // otherwise we return the value
    return arrSort[i - 1].value;
}
exports.weightedMedian = weightedMedian;
function min(results) {
    if (results.length === 0) {
        throw new Error("Cannot reduce empty array.");
    }
    return results.reduce((val, current) => (val.lt(current) ? val : current), results[0]);
}
exports.min = min;
function max(results) {
    if (results.length === 0) {
        throw new Error("Cannot reduce empty array.");
    }
    return results.reduce((val, current) => (val.gt(current) ? val : current), results[0]);
}
exports.max = max;
// This export function returns the ratio between the max value and the min value.
// If we pull data that may be negative, this information is not entirely relevant.
function variance(results) {
    if (results?.length === 0) {
        throw new Error("Cannot take variance of empty array");
    }
    const arrSort = results
        .slice()
        .sort((n1, n2) => n1.minus(n2).toNumber());
    const min = arrSort[0];
    const max = arrSort[arrSort.length - 1];
    return max.minus(min);
}
exports.variance = variance;
////// BIG.JS UTILS
function safeDiv(number_, denominator, decimals = 20) {
    const oldDp = big_js_1.Big.DP;
    big_js_1.Big.DP = decimals;
    const result = number_.div(denominator);
    big_js_1.Big.DP = oldDp;
    return result;
}
exports.safeDiv = safeDiv;
function safeMul(...n) {
    if (n.length === 0) {
        throw new Error(`need to provide elements to multiply ${n}`);
    }
    let result = new big_js_1.Big(1);
    for (const x of n) {
        result = result.mul(x);
    }
    return result;
}
exports.safeMul = safeMul;
function safeNthRoot(big, nthRoot, decimals = 20) {
    if (nthRoot <= 0) {
        throw new Error(`cannot take the nth root of a negative number`);
    }
    const oldDp = big_js_1.Big.DP;
    big_js_1.Big.DP = decimals;
    const oldPrecision = decimal_js_1.Decimal.precision;
    decimal_js_1.Decimal.set({ precision: decimals });
    const decimal = toDecimal(big);
    const frac = new decimal_js_1.Decimal(1).div(nthRoot);
    const root = big.s === -1
        ? decimal.abs().pow(frac).mul(new decimal_js_1.Decimal(big.s))
        : decimal.pow(frac);
    const result = fromDecimal(root);
    decimal_js_1.Decimal.set({ precision: oldPrecision });
    big_js_1.Big.DP = oldDp;
    return result;
}
exports.safeNthRoot = safeNthRoot;
function safeSqrt(n, decimals = 20) {
    const oldDp = big_js_1.Big.DP;
    big_js_1.Big.DP = decimals;
    const result = n.sqrt();
    big_js_1.Big.DP = oldDp;
    return result;
}
exports.safeSqrt = safeSqrt;
function safePow(n, exp, decimals = 20) {
    const oldDp = big_js_1.Big.DP;
    big_js_1.Big.DP = decimals;
    const oldPrecision = decimal_js_1.Decimal.precision;
    decimal_js_1.Decimal.set({ precision: decimals });
    const base = toDecimal(n);
    const value = base.pow(exp);
    const result = fromDecimal(value);
    decimal_js_1.Decimal.set({ precision: oldPrecision });
    big_js_1.Big.DP = oldDp;
    return result;
}
exports.safePow = safePow;
/**
 * Convert a BN.js to a Big.js
 * @param n - the BN.js object to convert
 * @param decimals - the number of decimal places to scale the BN.js
 *
 * @returns Big.js
 */
function fromBN(n, decimals = 0) {
    let mantissa = new bn_js_1.default(n, 10);
    let s = 1;
    const c = [];
    const ZERO = new bn_js_1.default(0, 10);
    const TEN = new bn_js_1.default(10, 10);
    if (mantissa.lt(ZERO)) {
        s = -1;
        mantissa = mantissa.abs();
    }
    while (mantissa.gt(ZERO)) {
        c.unshift(mantissa.mod(TEN).toNumber());
        mantissa = mantissa.div(TEN);
    }
    const e = c.length - decimals - 1;
    const result = new big_js_1.Big(0);
    if (c.length === 0) {
        return result;
    }
    result.s = s;
    result.c = c;
    result.e = e;
    return result;
}
exports.fromBN = fromBN;
/**
 * Convert a BigInt to a Big.js
 * @param n - the BigInt to convert
 *
 * @returns Big.js
 */
function fromBigint(n) {
    const big = new big_js_1.Big(n.toString(10));
    return big;
}
exports.fromBigint = fromBigint;
/**
 * Convert a Big.js to a Decimal.js
 * @param big - the Big.js object to convert
 * @param decimals - the number of decimal places
 *
 * @returns Decimal.js
 */
function toDecimal(big, decimals = 20) {
    const oldPrecision = decimal_js_1.Decimal.precision;
    decimal_js_1.Decimal.set({ precision: decimals });
    const decimal = new decimal_js_1.Decimal(big.toFixed(decimals, 0));
    decimal_js_1.Decimal.set({ precision: oldPrecision });
    return decimal;
}
exports.toDecimal = toDecimal;
/**
 * Convert a Decimal.js to a Big.js
 * @param decimal - the Decimal.js object to convert
 * @param decimals - the number of decimal places
 *
 * @returns Big.js
 */
function fromDecimal(decimal, decimals = 20) {
    if (decimal.isNaN()) {
        throw new TypeError(`cannot convert NaN decimal.js to Big.js`);
    }
    if (!decimal.isFinite()) {
        throw new TypeError(`cannot convert INF decimal.js to Big.js`);
    }
    const big = new big_js_1.Big(decimal.toFixed(decimals, 0));
    return big;
}
exports.fromDecimal = fromDecimal;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2JpZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBNkI7QUFDN0Isa0RBQXVCO0FBQ3ZCLDJDQUFxQztBQVFyQyxTQUFTLFVBQVUsQ0FBQyxDQUFNLEVBQUUsQ0FBTTtJQUNoQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNaLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUNELElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ1osT0FBTyxDQUFDLENBQUMsQ0FBQztJQUNaLENBQUM7SUFDRCxPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFnQixNQUFNLENBQUMsT0FBbUI7SUFDeEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxNQUFNO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBRTVFLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakQsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzFDLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDN0IsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEQsT0FBTyxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksWUFBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNELE9BQU8sT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUMxQixD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QUNILFNBQWdCLFdBQVcsQ0FBQyxPQUFnQixFQUFFLFFBQVEsR0FBRyxFQUFFO0lBQ3pELElBQUksT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUM7UUFDcEIsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUM7UUFDeEIsTUFBTSxJQUFJLFNBQVMsQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLFlBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQVhELGtDQVdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmlnIH0gZnJvbSBcImJpZy5qc1wiO1xuaW1wb3J0IEJOIGZyb20gXCJibi5qc1wiO1xuaW1wb3J0IHsgRGVjaW1hbCB9IGZyb20gXCJkZWNpbWFsLmpzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2VpZ2h0ZWRWYWx1ZSB7XG4gIGlkeDogbnVtYmVyO1xuICB2YWx1ZTogQmlnO1xuICB3ZWlnaHQ6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gY29tcGFyYXRvcihhOiBCaWcsIGI6IEJpZyk6IG51bWJlciB7XG4gIGlmIChhLmd0KGIpKSB7XG4gICAgcmV0dXJuIDE7XG4gIH1cbiAgaWYgKGEubHQoYikpIHtcbiAgICByZXR1cm4gLTE7XG4gIH1cbiAgcmV0dXJuIDA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZWRpYW4ocmVzdWx0czogQXJyYXk8QmlnPik6IEJpZyB7XG4gIGlmICghcmVzdWx0cz8ubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgdGFrZSBtZWRpYW4gb2YgZW1wdHkgYXJyYXkuXCIpO1xuXG4gIGNvbnN0IGFyclNvcnQgPSByZXN1bHRzLnNsaWNlKCkuc29ydChjb21wYXJhdG9yKTtcbiAgY29uc3QgbWlkID0gTWF0aC5jZWlsKGFyclNvcnQubGVuZ3RoIC8gMik7XG4gIGlmIChhcnJTb3J0Lmxlbmd0aCAlIDIgPT09IDApIHtcbiAgICBjb25zdCBhZGRpdGlvbiA9IGFyclNvcnRbbWlkXS5hZGQoYXJyU29ydFttaWQgLSAxXSk7XG4gICAgcmV0dXJuIHNhZmVEaXYoYWRkaXRpb24sIG5ldyBCaWcoMi4wKSk7XG4gIH1cbiAgcmV0dXJuIGFyclNvcnRbbWlkIC0gMV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3ZWlnaHRlZEF2ZXJhZ2UodjE6IEJpZywgdzE6IEJpZywgdjI6IEJpZywgdzI6IEJpZyk6IEJpZyB7XG4gIHJldHVybiBzYWZlRGl2KHNhZmVNdWwodjEsIHcxKS5hZGQoc2FmZU11bCh2MiwgdzIpKSwgdzEuYWRkKHcyKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3ZWlnaHRlZE1lZGlhbihyZXN1bHRzOiBBcnJheTxXZWlnaHRlZFZhbHVlPik6IEJpZyB7XG4gIGlmICghcmVzdWx0cz8ubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgdGFrZSBtZWRpYW4gb2YgZW1wdHkgYXJyYXkuXCIpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdHMubGVuZ3RoOyArK2kpIHtcbiAgICBpZiAocmVzdWx0c1tpXS53ZWlnaHQgPT09IDApIHtcbiAgICAgIHJlc3VsdHNbaV0ud2VpZ2h0ID0gMTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBhcnJTb3J0ID0gcmVzdWx0cy5zbGljZSgpLnNvcnQoKGEsIGIpID0+IGNvbXBhcmF0b3IoYS52YWx1ZSwgYi52YWx1ZSkpO1xuICBjb25zdCBoYWxmV2VpZ2h0ID0gYXJyU29ydC5yZWR1Y2UoKHN1bSwgeyB3ZWlnaHQgfSkgPT4gd2VpZ2h0ICsgc3VtLCAwKSAvIDI7XG4gIGxldCBpID0gMDtcbiAgbGV0IHcgPSAwO1xuXG4gIC8vIGdldCB0aGUgaW5kZXggKGkpIGFuZCB0b3RhbCB3ZWlnaHQgKHcpIG9mIGl0ZW0ganVzdCBhYm92ZSBoYWxmXG4gIGZvciAoOyB3IDwgaGFsZldlaWdodDsgKytpKSB7XG4gICAgdyA9IHcgKyBhcnJTb3J0W2ldLndlaWdodDtcbiAgfVxuXG4gIC8vIGlmIGl0IGFjdHVhbGx5IGlzIGV4YWN0bHkgdGhlIGhhbGYsIHdlIG5lZWQgdG8gdGFrZSB0aGUgYXZlcmFnZVxuICBpZiAodyA9PT0gaGFsZldlaWdodCkge1xuICAgIHJldHVybiB3ZWlnaHRlZEF2ZXJhZ2UoXG4gICAgICBhcnJTb3J0W2kgLSAxXS52YWx1ZSxcbiAgICAgIG5ldyBCaWcoYXJyU29ydFtpIC0gMV0ud2VpZ2h0KSxcbiAgICAgIGFyclNvcnRbaV0udmFsdWUsXG4gICAgICBuZXcgQmlnKGFyclNvcnRbaV0ud2VpZ2h0KVxuICAgICk7XG4gIH1cblxuICAvLyBvdGhlcndpc2Ugd2UgcmV0dXJuIHRoZSB2YWx1ZVxuICByZXR1cm4gYXJyU29ydFtpIC0gMV0udmFsdWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtaW4ocmVzdWx0czogQXJyYXk8QmlnPik6IEJpZyB7XG4gIGlmIChyZXN1bHRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCByZWR1Y2UgZW1wdHkgYXJyYXkuXCIpO1xuICB9XG4gIHJldHVybiByZXN1bHRzLnJlZHVjZShcbiAgICAodmFsLCBjdXJyZW50KSA9PiAodmFsLmx0KGN1cnJlbnQpID8gdmFsIDogY3VycmVudCksXG4gICAgcmVzdWx0c1swXVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF4KHJlc3VsdHM6IEFycmF5PEJpZz4pOiBCaWcge1xuICBpZiAocmVzdWx0cy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgcmVkdWNlIGVtcHR5IGFycmF5LlwiKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0cy5yZWR1Y2UoXG4gICAgKHZhbCwgY3VycmVudCkgPT4gKHZhbC5ndChjdXJyZW50KSA/IHZhbCA6IGN1cnJlbnQpLFxuICAgIHJlc3VsdHNbMF1cbiAgKTtcbn1cblxuLy8gVGhpcyBleHBvcnQgZnVuY3Rpb24gcmV0dXJucyB0aGUgcmF0aW8gYmV0d2VlbiB0aGUgbWF4IHZhbHVlIGFuZCB0aGUgbWluIHZhbHVlLlxuLy8gSWYgd2UgcHVsbCBkYXRhIHRoYXQgbWF5IGJlIG5lZ2F0aXZlLCB0aGlzIGluZm9ybWF0aW9uIGlzIG5vdCBlbnRpcmVseSByZWxldmFudC5cbmV4cG9ydCBmdW5jdGlvbiB2YXJpYW5jZShyZXN1bHRzOiBBcnJheTxCaWc+KTogQmlnIHtcbiAgaWYgKHJlc3VsdHM/Lmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCB0YWtlIHZhcmlhbmNlIG9mIGVtcHR5IGFycmF5XCIpO1xuICB9XG4gIGNvbnN0IGFyclNvcnQgPSByZXN1bHRzXG4gICAgLnNsaWNlKClcbiAgICAuc29ydCgobjE6IEJpZywgbjI6IEJpZykgPT4gbjEubWludXMobjIpLnRvTnVtYmVyKCkpO1xuICBjb25zdCBtaW4gPSBhcnJTb3J0WzBdO1xuICBjb25zdCBtYXggPSBhcnJTb3J0W2FyclNvcnQubGVuZ3RoIC0gMV07XG4gIHJldHVybiBtYXgubWludXMobWluKTtcbn1cblxuLy8vLy8vIEJJRy5KUyBVVElMU1xuXG5leHBvcnQgZnVuY3Rpb24gc2FmZURpdihudW1iZXJfOiBCaWcsIGRlbm9taW5hdG9yOiBCaWcsIGRlY2ltYWxzID0gMjApOiBCaWcge1xuICBjb25zdCBvbGREcCA9IEJpZy5EUDtcbiAgQmlnLkRQID0gZGVjaW1hbHM7XG4gIGNvbnN0IHJlc3VsdCA9IG51bWJlcl8uZGl2KGRlbm9taW5hdG9yKTtcbiAgQmlnLkRQID0gb2xkRHA7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYWZlTXVsKC4uLm46IEJpZ1tdKTogQmlnIHtcbiAgaWYgKG4ubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBuZWVkIHRvIHByb3ZpZGUgZWxlbWVudHMgdG8gbXVsdGlwbHkgJHtufWApO1xuICB9XG5cbiAgbGV0IHJlc3VsdCA9IG5ldyBCaWcoMSk7XG4gIGZvciAoY29uc3QgeCBvZiBuKSB7XG4gICAgcmVzdWx0ID0gcmVzdWx0Lm11bCh4KTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYWZlTnRoUm9vdChiaWc6IEJpZywgbnRoUm9vdDogbnVtYmVyLCBkZWNpbWFscyA9IDIwKTogQmlnIHtcbiAgaWYgKG50aFJvb3QgPD0gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgY2Fubm90IHRha2UgdGhlIG50aCByb290IG9mIGEgbmVnYXRpdmUgbnVtYmVyYCk7XG4gIH1cblxuICBjb25zdCBvbGREcCA9IEJpZy5EUDtcbiAgQmlnLkRQID0gZGVjaW1hbHM7XG4gIGNvbnN0IG9sZFByZWNpc2lvbiA9IERlY2ltYWwucHJlY2lzaW9uO1xuICBEZWNpbWFsLnNldCh7IHByZWNpc2lvbjogZGVjaW1hbHMgfSk7XG5cbiAgY29uc3QgZGVjaW1hbCA9IHRvRGVjaW1hbChiaWcpO1xuICBjb25zdCBmcmFjID0gbmV3IERlY2ltYWwoMSkuZGl2KG50aFJvb3QpO1xuICBjb25zdCByb290OiBEZWNpbWFsID1cbiAgICBiaWcucyA9PT0gLTFcbiAgICAgID8gZGVjaW1hbC5hYnMoKS5wb3coZnJhYykubXVsKG5ldyBEZWNpbWFsKGJpZy5zKSlcbiAgICAgIDogZGVjaW1hbC5wb3coZnJhYyk7XG5cbiAgY29uc3QgcmVzdWx0OiBCaWcgPSBmcm9tRGVjaW1hbChyb290KTtcblxuICBEZWNpbWFsLnNldCh7IHByZWNpc2lvbjogb2xkUHJlY2lzaW9uIH0pO1xuICBCaWcuRFAgPSBvbGREcDtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2FmZVNxcnQobjogQmlnLCBkZWNpbWFscyA9IDIwKTogQmlnIHtcbiAgY29uc3Qgb2xkRHAgPSBCaWcuRFA7XG4gIEJpZy5EUCA9IGRlY2ltYWxzO1xuICBjb25zdCByZXN1bHQgPSBuLnNxcnQoKTtcbiAgQmlnLkRQID0gb2xkRHA7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYWZlUG93KG46IEJpZywgZXhwOiBudW1iZXIsIGRlY2ltYWxzID0gMjApOiBCaWcge1xuICBjb25zdCBvbGREcCA9IEJpZy5EUDtcbiAgQmlnLkRQID0gZGVjaW1hbHM7XG5cbiAgY29uc3Qgb2xkUHJlY2lzaW9uID0gRGVjaW1hbC5wcmVjaXNpb247XG4gIERlY2ltYWwuc2V0KHsgcHJlY2lzaW9uOiBkZWNpbWFscyB9KTtcbiAgY29uc3QgYmFzZSA9IHRvRGVjaW1hbChuKTtcbiAgY29uc3QgdmFsdWUgPSBiYXNlLnBvdyhleHApO1xuICBjb25zdCByZXN1bHQgPSBmcm9tRGVjaW1hbCh2YWx1ZSk7XG5cbiAgRGVjaW1hbC5zZXQoeyBwcmVjaXNpb246IG9sZFByZWNpc2lvbiB9KTtcbiAgQmlnLkRQID0gb2xkRHA7XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IGEgQk4uanMgdG8gYSBCaWcuanNcbiAqIEBwYXJhbSBuIC0gdGhlIEJOLmpzIG9iamVjdCB0byBjb252ZXJ0XG4gKiBAcGFyYW0gZGVjaW1hbHMgLSB0aGUgbnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHNjYWxlIHRoZSBCTi5qc1xuICpcbiAqIEByZXR1cm5zIEJpZy5qc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZnJvbUJOKG46IEJOLCBkZWNpbWFscyA9IDApOiBCaWcge1xuICBsZXQgbWFudGlzc2E6IEJOID0gbmV3IEJOKG4sIDEwKTtcbiAgbGV0IHMgPSAxO1xuICBjb25zdCBjOiBBcnJheTxudW1iZXI+ID0gW107XG4gIGNvbnN0IFpFUk8gPSBuZXcgQk4oMCwgMTApO1xuICBjb25zdCBURU4gPSBuZXcgQk4oMTAsIDEwKTtcbiAgaWYgKG1hbnRpc3NhLmx0KFpFUk8pKSB7XG4gICAgcyA9IC0xO1xuICAgIG1hbnRpc3NhID0gbWFudGlzc2EuYWJzKCk7XG4gIH1cbiAgd2hpbGUgKG1hbnRpc3NhLmd0KFpFUk8pKSB7XG4gICAgYy51bnNoaWZ0KG1hbnRpc3NhLm1vZChURU4pLnRvTnVtYmVyKCkpO1xuICAgIG1hbnRpc3NhID0gbWFudGlzc2EuZGl2KFRFTik7XG4gIH1cbiAgY29uc3QgZSA9IGMubGVuZ3RoIC0gZGVjaW1hbHMgLSAxO1xuICBjb25zdCByZXN1bHQgPSBuZXcgQmlnKDApO1xuICBpZiAoYy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHJlc3VsdC5zID0gcztcbiAgcmVzdWx0LmMgPSBjO1xuICByZXN1bHQuZSA9IGU7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogQ29udmVydCBhIEJpZ0ludCB0byBhIEJpZy5qc1xuICogQHBhcmFtIG4gLSB0aGUgQmlnSW50IHRvIGNvbnZlcnRcbiAqXG4gKiBAcmV0dXJucyBCaWcuanNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZyb21CaWdpbnQobjogYmlnaW50KTogQmlnIHtcbiAgY29uc3QgYmlnID0gbmV3IEJpZyhuLnRvU3RyaW5nKDEwKSk7XG4gIHJldHVybiBiaWc7XG59XG5cbi8qKlxuICogQ29udmVydCBhIEJpZy5qcyB0byBhIERlY2ltYWwuanNcbiAqIEBwYXJhbSBiaWcgLSB0aGUgQmlnLmpzIG9iamVjdCB0byBjb252ZXJ0XG4gKiBAcGFyYW0gZGVjaW1hbHMgLSB0aGUgbnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzXG4gKlxuICogQHJldHVybnMgRGVjaW1hbC5qc1xuICovXG5leHBvcnQgZnVuY3Rpb24gdG9EZWNpbWFsKGJpZzogQmlnLCBkZWNpbWFscyA9IDIwKTogRGVjaW1hbCB7XG4gIGNvbnN0IG9sZFByZWNpc2lvbiA9IERlY2ltYWwucHJlY2lzaW9uO1xuXG4gIERlY2ltYWwuc2V0KHsgcHJlY2lzaW9uOiBkZWNpbWFscyB9KTtcbiAgY29uc3QgZGVjaW1hbCA9IG5ldyBEZWNpbWFsKGJpZy50b0ZpeGVkKGRlY2ltYWxzLCAwKSk7XG4gIERlY2ltYWwuc2V0KHsgcHJlY2lzaW9uOiBvbGRQcmVjaXNpb24gfSk7XG5cbiAgcmV0dXJuIGRlY2ltYWw7XG59XG5cbi8qKlxuICogQ29udmVydCBhIERlY2ltYWwuanMgdG8gYSBCaWcuanNcbiAqIEBwYXJhbSBkZWNpbWFsIC0gdGhlIERlY2ltYWwuanMgb2JqZWN0IHRvIGNvbnZlcnRcbiAqIEBwYXJhbSBkZWNpbWFscyAtIHRoZSBudW1iZXIgb2YgZGVjaW1hbCBwbGFjZXNcbiAqXG4gKiBAcmV0dXJucyBCaWcuanNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZyb21EZWNpbWFsKGRlY2ltYWw6IERlY2ltYWwsIGRlY2ltYWxzID0gMjApOiBCaWcge1xuICBpZiAoZGVjaW1hbC5pc05hTigpKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgY2Fubm90IGNvbnZlcnQgTmFOIGRlY2ltYWwuanMgdG8gQmlnLmpzYCk7XG4gIH1cblxuICBpZiAoIWRlY2ltYWwuaXNGaW5pdGUoKSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYGNhbm5vdCBjb252ZXJ0IElORiBkZWNpbWFsLmpzIHRvIEJpZy5qc2ApO1xuICB9XG5cbiAgY29uc3QgYmlnID0gbmV3IEJpZyhkZWNpbWFsLnRvRml4ZWQoZGVjaW1hbHMsIDApKTtcbiAgcmV0dXJuIGJpZztcbn1cbiJdfQ==